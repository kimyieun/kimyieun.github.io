---
title: "가설 검정 - 모평균 (z-test, t-test)"

categories:
  - datascience

---

## 가설 검정 - 모평균
1. one sample 
- 모집단의 평균에 대한 검정 (귀무가설 : mu = ?)
   1. 정규성 O 또는 n >= 25, 독립성 O, 모분산 O -> z 검정
   2. 정규성 O, 독립성 O, 모분산 X -> t 검정
2. two independent samples 
- 서로 다른 두 개 범주에 속한 모집단의 mu1, mu2 에 대한 검정 (귀무가설 : mu1 = mu2)
   1. 정규성 O, 독립성 O -> independent t-test (t-독립성 검정)
      1. 모분산이 같은 경우 - t-test
      2. 모분산이 다른 경우 - Welch's t-test
   2. 모집단에 대한 가정이 필요하지 않은 비모수 검정법 - Mann-Whitney U 검정
      1. 순위 기반으로 모집단 평균에 대한 비교라기 보다는 대소 관계에 대한 비교
      2. 귀무가설 : P(X1 > X2) = P(X1 < X2) (두 모집단은 동일한 분포를 지녔다.)
3. two paired samples
   - 동일 개체에서 treatment 전후의 두 모집단의 평균 비교 (귀무가설 : mu0 = mu0')
   1. 정규성 O, 독립성 O -> paired t-test
   2. 모집단에 대한 가정이 필요하지 않은 비모수 검정법 - Wilcoxon's Signed-rank Test
      1. 귀무가설 : 두 모집단은 동일한 분포를 지녔다.

## 가설검정
- 귀무가설 사실, 귀무가설 채택 - True Negative
- 귀무가설 사실, 귀무가설 기각 - False Positive (1종오류)
- 대립가설 사실, 귀무가설 채택 - False Negative (2종오류)
- 대립가설 사실, 귀무가설 기각 - True Positive
- 귀무가설은 보통 음성의 경우를 뜻하므로, 귀무가설을 채택하는 경우에는 negative 라고 말한다.

## p-value
- 귀무가설을 기각한 것이 오류일 확률 (type 1 error)
  - 귀무가설은 효과가 없다. 음성이다. 인데 우리가 얻은 데이터는 효과가 있다. 양성이다. 라는 증거를 발견한 것.
  - 그러면 **귀무가설이 참이라고 했을 때 우리가 이런 데이터를 우연히 얻을 수 있는 확률이 얼마인가?** 이걸 나타내는 값이 p-value 이다!
  - p-value 가 매우 작다면 얻은 결과가 우연히 발생할 가능성이 매우 낮다는 것이고, 효과가 있다는 강력한 증거가 된다.
  - p-value 가 크다면 현재 얻은 결과가 우연히 발생할 가능성이 높다는 것을 의미하고, 귀무가설을 기각할 수 없다.
- significance level, alpha (유의수준) - 귀무가설 기각을 판단하기 위한 pvalue 의 기준점
  - p-value 가 유의수준보다 크거나 같으면 귀무가설을 채택한다.

## 가설검정 절차
1. p-value(유의확률)에 의한 검정
   1. pvalue 를 계산하여 유의 수준과 비교하여 결론을 낸다.
2. 기각역에 의한 검정
   1. 기각역은 **귀무가설이 기각되고 대립가설이 채택되는 검정통계량의 영역**을 의미한다.
   2. 그러나 기각역 내에서도 귀무가설이 참이지만 귀무가설을 기각하는 확률은 존재한다. 이 확률이 유의수준이다.
      1. 일반적으로 유의수준은 5%로 정하지만, 1%, 10% 로 정하기도 한다.
      2. 유의수준이 5%이면, 검정통계량이 발생할 가능성이 5% 영역에서 발생하면 귀무가설이 맞을 가능성이 낮다고 판단한다는 의미이다.
      3. 기각역의 크기는 유의수준에 의해 결정되지만 위치는 대립가설에 의해 결정된다.
         1. 양측검정(모수가 특정값이 아니다), 단측검정(모수가 특정값보다 작다)

![Validation](/assets/images/critical.PNG){:width="=500px" height="300px"}{: .center}


## 예제 문제 코드 1
- 이마의 온도를 측정하여 체온을 구하는 온도계가 있습니다. 이 체온계는 동일한 센서로 16번의 측정을 하여 평균값을 온도로 출력합니다.
이 온도계의 센서로 실제 체온이 36.5도를 잴 경우 0.4도의 표준편차가 있다고 합니다. 이를 바탕으로 0.4를 모표준편차라고 가정합니다.
체온이 36.5보다 높을 경우 알람을 울리는 기능을 만든다고 합니다. 유의 수준을 0.05로 할 때, 다음 센서 출력이 왔을 때의 알람 여부를 구하세요.


- 귀무가설 : 모평균 = 36.5
- 대립가설 : 모평균 > 36.5

```python
X = [36.27, 37.10, 36.81, 36.10, 36.47, 37.36, 35.73, 36.53,
    37.21, 36.35, 36.43, 36.66, 37.30, 36.44, 36.52, 36.53]

from scipy.stats import norm
X_bar = np.mean(X)
n = len(X)
Z = (X_bar - 36.5) / (0.4/(n**0.5))
Z, 1-norm.cdf(Z) # 1.131249999999966 0.12897494127716136
```
- pvalue = 0.128 로 유의수준 0.05 보다 크므로 귀무가설을 기각하지 못한다.


## 예제 문제 1
1. 어느 기계의 평균 수명이 300일이라고 알려짐. 아니라는 주장이 나온다. 이때 해당 기계 25개를 표본으로 뽑아 조사하니 평균 수명이 310일이었다. 표준편차는 30일. 어느 의견이 더 타당한지 유의수준 5% 에서 검정하라.
   1. 대립가설 : 평균 수명 != 300일
   2. Z = 310 - 300 / (30 / sqrt(25)) = 1.67
   3. 기각역 : 유의수준이 0.05이므로 0.05/2=0.025 에 해당하는 값을 표준정규분포표에서 찾는다.
      1. 기각역 : +-1.96 
      2. 검정통계량인 1.67은 -1.96~1.96 사이인 채택역에 있으므로 귀무가설을 기각할 수 없다.

```python
from scipy import stats

xbar = 310
sigma = 30
n = 25

pvalue = 1 - stats.norm.cdf(xbar, loc=300, scale=sigma/np.sqrt(n)) * 2 
# 0.095로 0.05보다 크므로 귀무가설 기각할 수 없다.

critical_value = stats.norm.ppf(0.975, loc=300, scale=sigma/np.sqrt(n)) 
# 임계값 = 311.75로 검정통계량 310보다 크므로 기각역에 들어가지 않는다.
```

## 예제 문제 2

2. 과자 평균 중량이 50g 이라 주장한다. 소비자는 더 작다고 주장한다. 표본 100개 추출했더니, 평균 중량 41g이고 표준편차는 20g이다. 유의수준 1%에서 검정하여라.
   1. 대립가설 : 과자 평균 중량 < 50
   2. Z = 50 - 41 / (20 / sqrt(100)) = -4.5
   3. 기각역 : 유의수준이 0.01이므로 0.99에 해당하는 값을 표준정규분포표에서 찾는다.
      1. 기각역 : -2.33
      2. 검정통계량인 -4.5는 -2.33 보다 작으므로 기각역에 위치하므로 귀무가설을 기각한다.

```python
from scipy import stats
import numpy as np

xbar = 41
sigma = 20
n = 100

pvalue = 1 - stats.norm.cdf(xbar, loc=50, scale=sigma/np.sqrt(n)) * 2 
# 0.0003 으로 0.01 보다 매우 작으므로 귀무가설 기각한다.

critical_value = stats.norm.ppf(0.99, loc=50, scale=sigma/np.sqrt(n)) 
# 임계값 = 45.347로 검정통계량 41 보다 크므로 기각역에 들어간다. 
```

## t-test
- **두 집단의 평균을 비교**하는 검정 방법
- 귀무가설 : 두 집단의 평균값의 차이가 없다.
- 대립가설 : 두 집단의 평균값의 차이가 있다.
- 가정 : 표본의 독립성, 정규성, 등분산성

## t-test 종류
- one sample t-test : 한 집단의 평균이 모집단의 평균과 같은지 비교한다.
  - 모집단의 평균을 알고 있지만, 표준편차는 모른다.
  - **모집단은 정규 분포를 따르고 각 표본은 서로 독립이다.**
  - z = (표본 평균 - 모평균) / (표준편차 / sqrt(n)) 에서 표준편차 대신 표본표준편차(s)를 사용한다.
  - df = n - 1
- independent t-test : 서로 다른 모집단에서 추출된 두 독립된 집단의 평균의 차이를 비교한다.

![Validation](/assets/images/indep.PNG){:width="=300px" height="200px"}{: .center}

- paired t-test : 하나의 집단의 전/후의 차이를 비교한다.
  - 두 집단이 독립적이지 않다.

## one sample t-test 코드 예제 문제 1
OO 치즈는 슬라이스 당 무게를 20g 씩 잘라 만듭니다.

생산관리 부서에서 OO 치즈의 슬라이스 당 무게가 20g이 넘게 포장되고 있다고 주장을 했고,

포장기계에는 발생할 수 있는 표준편차가 0.4g 이라고 적혀 있지만, 생산 관리 부서는 이 내용을 인정하지 않고 있습니다.

하지만, 치즈 슬라이스 (모집단의) 무게는 정규분포를 따르고 있음을 인정합니다.

주어진 표본을 이용하여, 생산 관리 부서에서 최대한 납득할 수 있는 방법으로, 생산관리 부서의 주장을 받아들일 수 있는지 조사해봅니다. (유의 수준: 0.05)

```python
# 귀무가설 : 치즈 슬라이스 당 무게의 모평균 = 20, 대립가설 : 치즈 슬라이스 당 무게의 모평균 > 20
# 표준편차=0.4 를 인정하지 않기 때문에 모표준편차는 모르는 상태이다. -> T 분포
X = [
    19.89, 20.61, 21.25, 19.67, 19.72, 20.14, 20.40, 19.72, 20.35, 19.89, 
    20.04, 20.12, 19.83, 19.31, 20.37, 20.68, 19.27, 19.69, 20.13, 20.07, 
    20.09, 19.53, 20.14, 19.87, 19.78, 19.47, 19.53, 20.73, 19.92, 19.41
]

from scipy.stats import t

X_bar = np.mean(X)
s = np.std(X, ddof=1) # df = n-1
n= len(X)
df = n-1
T = (X_bar - 20)/(s/(n**0.5))
T, 1-t.cdf(T, df) # (-0.15518626024081011, 0.5611252033714988)
```
- pvalue > 0.05 이므로 귀무가설 기각하지 못한다.

## independence t-test 예제 문제 
 
동일한 모델의 배터리의 성능이 북반구와 남반구에서 차이가 있는지를 검정하고자 합니다.

북반구에 있는 실험실 A, 남반구에 있는 실험실 B에서 동일한 모델의 배터리를

동일한 여건으로 성능 지속시간을 측정하였습니다.

북반구와 남반구에서 성능이 차이가 있는지 판단해봅니다. (유의 수준 5%)

표본들의 성능 측정은 독립적으로 이루어집니다. 성능 지속 시간은 정규 분포를 따릅니다.

또한 모분산은 같다고 가정합니다.


```python
from scipy.stats import t

X1 = [7.57, 8.40, 8.11, 7.40, 7.77, 8.66, 7.03, 7.83, 8.51, 7.65, 7.73, 7.96]
X2 = [8.07, 8.65, 8.01, 7.65, 7.54, 7.75, 7.46, 7.67, 7.95, 8.64]

n1 = len(X1)
n2 = len(X2)
X1_bar = np.mean(X1)
X2_bar = np.mean(X2)
S1_sq = np.var(X1, ddof=1)
S2_sq = np.var(X2, ddof=1)

SP_sq = ((n1-1)*S1_sq + (n2-1)*S2_sq)/(n1+n2-2)
T = (X1_bar-X2_bar)/((SP_sq*(1/n1+1/n2))**0.5)
t.sf(-T, df=n1+n2-2)*2


# 양측검정의 경우 ttest_ind 사용 가능
from scipy.stats import ttest_ind
ttest_ind(X1, X2, equal_var=True) # independence t-test
ttest_ind(X1, X2, equal_var=False) # Welch's t-test 
```

## Welch's t-Test

데이터사이언스 강의는 오전과 오후 두 반으로 나누어 강의가 진행됩니다.

모두 동일한 내용이고, 강사도 같고 성적은 같다는 생각이 지배적입니다.

오전/오후 반의 일부 수강생의 성적을 가지고, 오전 / 오후 반의 성적에 차이가 있는지를 판단해봅니다. (유의 수준 5%)

성적은 정규 분포를 따르고, 수강생의 개개인의 성적은 독립임을 가정합니다.
    
그리고, 두 반의 분산은 같지 않습니다.

```python
X1 = [75, 94, 88, 71, 80, 100, 63, 81, 96]
X2 = [69, 94, 85, 64, 75, 100, 53, 77, 97, 72, 74, 81, 99, 74, 77, 77]

from scipy.stats import ttest_ind
ttest_ind(X1, X2, equal_var=False)
```


## Mann-Whitney U 검정
A부서와 임직원의 나이와 B부서의 임직원 나이의 차이를 비교해 봅니다.

𝐻0:𝑃(𝑋1>𝑋2)=𝑃(𝑋1<𝑋2)
 (두 모집단은 동일한 분포를 지녔다)

𝐻1:𝑃(𝑋1>𝑋2)≠𝑃(𝑋1<𝑋2)
 (모집단 1이 모집단 2 보다 다른 영역에 분포한다.)

```python
s_A = pd.Series([25, 35, 38, 49, 51, 43, 29, 54], name='age')
s_B = pd.Series([28, 42, 45, 31, 48, 43, 25, 55, 33], name='age')

from scipy.stats import mannwhitneyu
mannwhitneyu(s_A, s_B, use_continuity=False, alternative='two-sided')
# use_continuity : default : True, continuous 한 통계량일 때 사용한다.
# MannwhitneyuResult(statistic=32.0, pvalue=0.6999612764311128)
```

## paired t-test
- pair 를 이루는 집단에서 각 pair 의 차이로 두 모집단의 평균이 같을지를 검정한다.
- 귀무가설 : 각 pair의 차이의 평균은 0이다.
- 대립가설 : 각 pair의 차이의 평균은 0이 아니다. or < 0 or > 0

![Validation](/assets/images/pairedttest.PNG){:width="=200px" height="100px"}{: .center}
- d : 두 집단 차이의 평균
- s : 두 집단 차이의 표본 표준편차
- n : 표본의 수 (pair 의 수)
- df : n-1 (n : pair의 수)

## paired t-test 예제 1
S전자는 직원 마음 건강을 위하여 정기적으로 마음 건강 지수를 측정합니다.

직원의 마음 건강을 높히기 위해 심리 치료사 지희를 고용했습니다.

심리 치료사의 효과를 파악하기 위해,

무작위로 16명을 대상으로 지희 상담사에게 상담하기 전과 후의 마음 건강 지수를 측정합니다.

마음 건강 지수는 높을 수록 좋은 상태를 나타냅니다.

심리 치료 이후 마음 건강 지수가 높아 졌는지를 검정해 봅니다. (유의 수준 5%)

귀무가설 : DIFF = 0
대립가설 : DIFF > 0

```python
X = [5.91, 8.00, 7.28, 5.49, 6.42, 8.65, 4.57, 6.57, 8.27, 6.13, 6.32, 6.91, 8.49, 6.36, 6.56, 6.57]
X_p = [5.87, 9.00, 7.92, 5.24, 6.63, 9.98, 3.86, 6.86, 9.40, 6.20, 6.48, 7.36, 9.74, 6.54, 6.83, 6.85]

X_diff = np.array(X_p) - np.array(X) # 후에서 전을 빼줘야 통계값이 + 로 나옴
X_diff_bar = np.mean(X_diff)
X_diff_s = np.std(X_diff, ddof=1)
n = len(X_diff)
T = X_diff_bar / (X_diff_s/(n**0.5))
T, t.sf(-T, df=n-1)
# (2.801268271622578, 0.006712663916686075)


from scipy.stats import ttest_rel # 양측검정만 지원
ttest_rel(X, X_p)  
# Ttest_relResult(statistic=-2.801268271622578, pvalue=0.01342532783337215)
```

## Wilcoxon's Signed-rank Test

```python
X =   [110, 122, 125, 120, 140, 124, 123, 137, 135, 145]
X_p = [125, 115, 130, 140, 140, 115, 140, 125, 140, 135]

from scipy.stats import wilcoxon
wilcoxon(X, X_p, correction=False, alternative='two-sided',  mode='approx', zero_method='wilcox')
# WilcoxonResult(statistic=18.0, pvalue=0.5936305914425295)
```

## 비율 Z 검정 
- 이진 확률 변수의 1인 비율 p 에 대한 검정
- 귀무가설 : p = p0
- 대립가설 : p < p0, p != p0, p > p0
- 베르누이 분포
  - 평균 : p, 분산 : p(1-p)

## 예제 문제 1

A 백신 회사에서는 모든 종류의 독감 바이러스에 대한 항체를 포함할 수 없으니,

그 해의 백신에 포함될 독감 바이러스 항체를 결정하기 위해 사람들이 보유하고 있는 항체를 조사합니다.

먼저 후보군을 선택하여 포함 유무를 판단하고자 합니다.

조사 결과 10% 이상 항체를 보유하고 있을 확률이 95% 초과한다면 후보에서 제외합니다

Z 독감 바이러스 항체 보유 여부를 1,600 명의 사람을 대상으로 조사한 결과, 165 명이 항체를 보유한 것으로 나타났습니다.

Z 독감 바이러스 항체를 독감 백신에 포함 시킬 후보에 포함시킬지 판단해봅니다.

- 귀무가설 : p = 0.1
- 대립가설 : p > 0.1

```python
p = 0.1
p_bar = 165/1600
n = 1600
var = p*(1-p)
z = (p_bar-p)/(var/n)**0.5
z, norm.sf(z) # (0.41666666666666513, 0.3384611195106902)
```